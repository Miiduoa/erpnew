<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP規劃師刷題系統 - 完整版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --light-blue: #dbeafe;
            --success-green: #059669;
            --light-green: #d1fae5;
            --warning-orange: #d97706;
            --light-orange: #fed7aa;
            --error-red: #dc2626;
            --light-red: #fecaca;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--gray-50) 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* Header */
        .header {
            background: white;
            box-shadow: var(--shadow);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
        }

        .stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-blue);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: var(--light-blue);
            transform: translateY(-1px);
        }

        /* Content Panels */
        .panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Question Overview Panel */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .question-number {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
        }

        .question-number:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .question-number.unanswered {
            background: var(--gray-100);
            border: 2px solid var(--gray-200);
        }

        .question-number.correct {
            background: var(--success-green);
            color: white;
        }

        .question-number.incorrect {
            background: var(--error-red);
            color: white;
        }

        .question-number.current {
            background: var(--primary-blue);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Question Panel */
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .question-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .question-info {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .question-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .question-badge.chapter {
            background: var(--light-blue);
            color: var(--primary-blue);
        }

        .question-badge.number {
            background: var(--primary-blue);
            color: white;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            color: var(--gray-800);
        }

        .options {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .option {
            padding: 1rem 1.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }

        .option:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .option.correct {
            border-color: var(--success-green);
            background: var(--light-green);
        }

        .option.incorrect {
            border-color: var(--error-red);
            background: var(--light-red);
        }

        .option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            margin-right: 1rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .option.selected .option-letter {
            background: var(--primary-blue);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success-green);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error-red);
            color: white;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .question-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .question-input {
            padding: 0.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            width: 80px;
            text-align: center;
            font-size: 1rem;
        }

        /* Progress Bar */
        .progress-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--success-green));
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        /* Results Panel */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .result-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .result-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .result-number.correct {
            color: var(--success-green);
        }

        .result-number.incorrect {
            color: var(--error-red);
        }

        .result-number.total {
            color: var(--primary-blue);
        }

        /* Browse Panel Styles */
        .browse-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .browse-item:hover {
            background: white;
            border-color: var(--primary-blue);
            box-shadow: var(--shadow);
        }

        .browse-question-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .browse-question-number {
            background: var(--primary-blue);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .browse-chapter {
            background: var(--light-blue);
            color: var(--primary-blue);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .browse-question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            color: var(--gray-800);
        }

        .browse-options {
            margin-bottom: 1rem;
        }

        .browse-option {
            padding: 0.5rem 0;
            color: var(--gray-700);
            border-left: 3px solid transparent;
            padding-left: 1rem;
        }

        .browse-option.correct-answer {
            background: var(--light-green);
            border-left-color: var(--success-green);
            font-weight: 500;
            color: var(--success-green);
        }

        .browse-answer {
            background: var(--success-green);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
        }

        .chapter-filter, #chapter-filter {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chapter-filter:hover, #chapter-filter:hover {
            border-color: var(--primary-blue);
        }

        .chapter-filter:focus, #chapter-filter:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--primary-blue);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--light-blue);
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: var(--success-green);
            background: var(--light-green);
        }

        .file-upload-area input[type="file"] {
            margin: 1rem 0;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            background: white;
        }

        /* Wrong Questions Practice Styles */
        .wrong-practice-welcome {
            text-align: center;
            padding: 3rem 2rem;
        }

        .wrong-practice-welcome h3 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .continue-btn {
            margin-top: 1rem !important;
            margin-left: 0 !important;
        }

        .incorrect-question-item {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .incorrect-question-item:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary-blue);
        }

        .question-option-display {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .question-option-correct {
            background: var(--light-green);
            border-left: 3px solid var(--success-green);
            color: var(--success-green);
        }

        .question-option-wrong {
            background: var(--light-red);
            border-left: 3px solid var(--error-red);
            color: var(--error-red);
        }

        .question-option-normal {
            background: var(--gray-50);
        }

        .memory-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-blue);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0.6;
            z-index: 1000;
            transition: all 0.3s ease;
            transform: translateY(10px);
        }

        .memory-status:hover {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .stats {
                gap: 1rem;
            }

            .overview-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 0.3rem;
                padding: 1rem;
            }

            .question-card {
                padding: 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .question-selector {
                justify-content: center;
            }

            .browse-question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .browse-item {
                padding: 1rem;
            }

            .chapter-filter, #chapter-filter {
                width: 100%;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">📚 ERP規劃師刷題系統 (完整版)</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="correctCount">0</div>
                    <div>答對</div>
                </div>

    <!-- 記憶狀態指示器 -->
    <div class="memory-status" id="memory-status">
        💾 記錄已自動保存
    </div>
                <div class="stat-item">
                    <div class="stat-number" id="incorrectCount">0</div>
                    <div>答錯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalAnswered">0</div>
                    <div>已答</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showPanel('overview')">題庫總覽</button>
            <button class="nav-tab" onclick="showPanel('practice')">開始刷題</button>
            <button class="nav-tab" onclick="showPanel('browse')">題庫瀏覽</button>
            <button class="nav-tab" onclick="showPanel('wrong')">錯題練習</button>
            <button class="nav-tab" onclick="showPanel('results')">答題統計</button>
            <button class="nav-tab" onclick="showPanel('debug')" id="debug-tab" style="display: none;">調試信息</button>
        </nav>

        <!-- 題庫總覽面板 -->
        <div id="overview-panel" class="panel active">
            <!-- 文件上傳區域 -->
            <div class="question-card" id="upload-section">
                <div class="question-header">
                    <h3>📁 題庫檔案上傳 (備用選項)</h3>
                </div>
                <div class="file-upload-area">
                    <div>📄 系統已自動嘗試載入題庫，如需手動上傳請選擇CSV文件</div>
                    <input type="file" id="csv-file-upload" accept=".csv">
                    <div>
                        <button class="btn btn-primary" onclick="uploadCSVFile()">手動上傳CSV題庫文件</button>
                    </div>
                    <p style="margin-top: 1rem; color: var(--gray-600); font-size: 0.9rem;">
                        <strong>系統正在自動載入完整題庫</strong><br>
                        如果自動載入失敗，可使用此功能手動上傳 ERP_Questions.csv 文件
                    </p>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-header">
                    <h3>答題進度</h3>
                    <span id="progress-text">0 / 0 (0%)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-header">
                    <h3>題庫總覽 (點選題號開始作答)</h3>
                </div>
                <div class="overview-grid" id="overview-grid">
                    <!-- 題目編號將由JavaScript生成 -->
                </div>
            </div>
        </div>

        <!-- 題庫瀏覽面板 -->
        <div id="browse-panel" class="panel">
            <div class="question-card">
                <div class="question-header">
                    <div class="question-info">
                        <h3>📖 題庫瀏覽模式</h3>
                        <span class="question-badge chapter" id="browse-filter">所有章節</span>
                    </div>
                    <div>
                        <select id="chapter-filter" onchange="filterByChapter()" class="btn btn-secondary">
                            <option value="">所有章節</option>
                        </select>
                    </div>
                </div>
                
                <div id="browse-container" style="max-height: 70vh; overflow-y: auto;">
                    <!-- 題目瀏覽內容將由JavaScript生成 -->
                </div>
            </div>
        </div>

        <!-- 刷題面板 -->
        <div id="practice-panel" class="panel">
            <div class="question-card">
                <div class="question-header">
                    <div class="question-info">
                        <span class="question-badge number" id="current-question-badge">題目 1</span>
                        <span class="question-badge chapter" id="current-chapter-badge">載入中...</span>
                    </div>
                </div>
                
                <div class="question-text" id="question-text">載入中...</div>
                
                <div class="options" id="options-container">
                    <!-- 選項將由JavaScript生成 -->
                </div>
                
                <div class="controls">
                    <div class="question-selector">
                        <label>跳至題目：</label>
                        <input type="number" class="question-input" id="question-input" min="1" max="500" placeholder="1">
                        <button class="btn btn-secondary" onclick="goToQuestion()">前往</button>
                    </div>
                    
                    <div>
                        <button class="btn btn-secondary" onclick="previousQuestion()" id="prev-btn">上一題</button>
                        <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn">下一題</button>
                        <button class="btn btn-success" onclick="submitAnswer()" id="submit-btn" style="display:none;">確認答案</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 錯題練習面板 -->
        <div id="wrong-panel" class="panel">
            <div class="question-card">
                <div class="question-header">
                    <div class="question-info">
                        <h3>❌ 錯題練習模式</h3>
                        <span class="question-badge number" id="wrong-progress-badge">準備中...</span>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="resetWrongQuestions()" style="margin-right: 1rem;">重置錯題記錄</button>
                        <button class="btn btn-primary" onclick="startWrongPractice()">開始錯題練習</button>
                    </div>
                </div>
                
                <div id="wrong-practice-container">
                    <div id="wrong-welcome" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">📚</div>
                        <h3 style="margin-bottom: 1rem;">錯題專項練習</h3>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">
                            專門練習答錯的題目，鞏固薄弱知識點<br>
                            <span id="wrong-count-text">請先完成一些題目來建立錯題庫</span>
                        </p>
                        <button class="btn btn-primary" onclick="startWrongPractice()">開始練習</button>
                    </div>

                    <div id="wrong-practice-content" style="display: none;">
                        <!-- 錯題練習的題目內容 -->
                        <div class="question-header">
                            <div class="question-info">
                                <span class="question-badge number" id="wrong-current-badge">錯題 1</span>
                                <span class="question-badge chapter" id="wrong-chapter-badge">載入中...</span>
                            </div>
                        </div>
                        
                        <div class="question-text" id="wrong-question-text">載入中...</div>
                        
                        <div class="options" id="wrong-options-container">
                            <!-- 選項將由JavaScript生成 -->
                        </div>
                        
                        <div class="controls">
                            <div class="question-selector">
                                <span>錯題進度：</span>
                                <span id="wrong-progress-text">0 / 0</span>
                            </div>
                            
                            <div>
                                <button class="btn btn-secondary" onclick="previousWrongQuestion()" id="wrong-prev-btn">上一題</button>
                                <button class="btn btn-primary" onclick="nextWrongQuestion()" id="wrong-next-btn">下一題</button>
                                <button class="btn btn-success" onclick="submitWrongAnswer()" id="wrong-submit-btn" style="display:none;">確認答案</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 答題統計面板 -->
        <div id="results-panel" class="panel">
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-number correct" id="result-correct">0</div>
                    <h4>答對題數</h4>
                </div>
                <div class="result-card">
                    <div class="result-number incorrect" id="result-incorrect">0</div>
                    <h4>答錯題數</h4>
                </div>
                <div class="result-card">
                    <div class="result-number total" id="result-total">0</div>
                    <h4>總答題數</h4>
                </div>
                <div class="result-card">
                    <div class="result-number" id="accuracy-rate" style="color: var(--warning-orange);">0%</div>
                    <h4>正確率</h4>
                </div>
            </div>

            <div class="question-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>錯題回顧</h3>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 0.9rem;">清除所有記錄</button>
                </div>
                <div id="incorrect-questions">
                    <p style="text-align: center; color: var(--gray-600); padding: 2rem;">
                        還沒有錯題記錄，繼續加油！ 💪
                    </p>
                </div>
            </div>
        </div>

        <!-- 調試信息面板 -->
        <div id="debug-panel" class="panel">
            <div class="question-card">
                <div class="question-header">
                    <h3>🔧 題庫調試信息</h3>
                </div>
                <div id="debug-content">
                    <p style="text-align: center; color: var(--gray-600); padding: 2rem;">
                        載入題庫後將顯示調試信息...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 題目數據載入
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {}; // 儲存用戶答案
        let showingAnswer = false;
        
        // 錯題練習相關
        let wrongQuestions = [];
        let currentWrongIndex = 0;
        let wrongAnswers = {};
        let showingWrongAnswer = false;

        // 記憶功能 - 數據持久化
        const STORAGE_KEYS = {
            USER_ANSWERS: 'erp_user_answers',
            WRONG_ANSWERS: 'erp_wrong_answers', 
            LAST_QUESTION: 'erp_last_question',
            LAST_WRONG_QUESTION: 'erp_last_wrong_question'
        };

        // 保存數據到localStorage
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.log('保存數據失敗:', error);
            }
        }

        // 從localStorage讀取數據
        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.log('讀取數據失敗:', error);
                return defaultValue;
            }
        }

        // 保存答題記錄
        function saveAnswers() {
            saveToStorage(STORAGE_KEYS.USER_ANSWERS, userAnswers);
            saveToStorage(STORAGE_KEYS.LAST_QUESTION, currentQuestionIndex);
            showMemoryStatus('記錄已保存');
        }

        // 保存錯題練習記錄
        function saveWrongAnswers() {
            saveToStorage(STORAGE_KEYS.WRONG_ANSWERS, wrongAnswers);
            saveToStorage(STORAGE_KEYS.LAST_WRONG_QUESTION, currentWrongIndex);
            showMemoryStatus('錯題記錄已保存');
        }

        // 顯示記憶狀態
        function showMemoryStatus(message = '記錄已自動保存') {
            const indicator = document.getElementById('memory-status');
            indicator.textContent = `💾 ${message}`;
            indicator.style.opacity = '1';
            indicator.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                indicator.style.opacity = '0.6';
                indicator.style.transform = 'translateY(10px)';
            }, 2000);
        }

        // 載入保存的數據
        function loadSavedData() {
            userAnswers = loadFromStorage(STORAGE_KEYS.USER_ANSWERS, {});
            wrongAnswers = loadFromStorage(STORAGE_KEYS.WRONG_ANSWERS, {});
            const lastQuestion = loadFromStorage(STORAGE_KEYS.LAST_QUESTION, 0);
            const lastWrongQuestion = loadFromStorage(STORAGE_KEYS.LAST_WRONG_QUESTION, 0);
            
            // 恢復到上次的題目位置
            currentQuestionIndex = Math.max(0, Math.min(lastQuestion, questions.length - 1));
            currentWrongIndex = Math.max(0, lastWrongQuestion);
            
            console.log(`載入保存的數據: ${Object.keys(userAnswers).length} 個答題記錄`);
        }

        // 清除所有記錄
        function clearAllData() {
            if (confirm('確定要清除所有答題記錄嗎？此操作無法復原！')) {
                localStorage.removeItem(STORAGE_KEYS.USER_ANSWERS);
                localStorage.removeItem(STORAGE_KEYS.WRONG_ANSWERS);
                localStorage.removeItem(STORAGE_KEYS.LAST_QUESTION);
                localStorage.removeItem(STORAGE_KEYS.LAST_WRONG_QUESTION);
                
                userAnswers = {};
                wrongAnswers = {};
                currentQuestionIndex = 0;
                currentWrongIndex = 0;
                
                updateStats();
                updateResults();
                generateOverview();
                updateWrongQuestionsDisplay();
                
                showNotification('所有記錄已清除！', 'success');
            }
        }

        // 初始化
        async function init() {
            // 顯示載入提示
            document.getElementById('question-text').textContent = '正在載入ERP題庫，請稍候...';
            
            await loadQuestions();
            
            if (questions.length === 0) {
                document.getElementById('question-text').textContent = '載入失敗，請重新整理頁面或手動上傳CSV文件。';
                return;
            }
            
            // 載入保存的答題記錄
            loadSavedData();
            
            // 初始化所有功能
            generateOverview();
            generateBrowseContent();
            generateChapterFilter();
            showQuestion(currentQuestionIndex);
            updateStats();
            updateResults();
            updateWrongQuestionsDisplay();
            
            // 檢查題目質量並報告
            checkQuestionQuality();
            
            // 根據載入的題目數量決定顯示模式
            if (questions.length >= 400) {
                // 成功載入完整題庫
                document.getElementById('upload-section').style.display = 'none';
                showNotification(`🎉 成功載入完整ERP題庫 (${questions.length} 題)！記錄已自動恢復`, 'success');
            } else if (questions.length > 50) {
                // 載入了部分題庫
                document.getElementById('upload-section').style.display = 'none';
                showNotification(`✅ 載入ERP題庫 (${questions.length} 題)，記錄已自動恢復`, 'success');
            } else {
                // 只有演示題目，顯示上傳區域
                showNotification(`📁 當前為演示模式 (${questions.length} 題)，建議上傳完整CSV文件`, 'success');
            }
            
            // 顯示恢復記錄的提示
            const savedCount = Object.keys(userAnswers).length;
            if (savedCount > 0) {
                setTimeout(() => {
                    showNotification(`💾 已恢復 ${savedCount} 道題的答題記錄`, 'success');
                }, 2000);
            }
        }

        // 檢查題目質量
        function checkQuestionQuality() {
            const problemQuestions = questions.filter(q => !q.options || q.options.length < 2);
            const incompleteQuestions = questions.filter(q => q.options && q.options.length < 4);
            const goodQuestions = questions.filter(q => q.options && q.options.length >= 4);
            
            console.log(`質量檢查報告:`);
            console.log(`- 總題目數: ${questions.length}`);
            console.log(`- 問題題目數 (選項<2): ${problemQuestions.length}`);
            console.log(`- 不完整題目數 (選項<4): ${incompleteQuestions.length}`);
            console.log(`- 完整題目數 (選項>=4): ${goodQuestions.length}`);
            
            if (problemQuestions.length > 0) {
                console.log('問題題目編號:', problemQuestions.map(q => q.id));
            }
            
            // 生成調試面板內容
            generateDebugContent(problemQuestions, incompleteQuestions, goodQuestions);
            
            // 如果有問題題目，顯示調試標籤
            if (problemQuestions.length > 0 || incompleteQuestions.length > 10) {
                document.getElementById('debug-tab').style.display = 'block';
            }
            
            // 如果問題題目很多，顯示警告
            if (problemQuestions.length > questions.length * 0.1) {
                setTimeout(() => {
                    showNotification(`⚠️ 發現 ${problemQuestions.length} 道題目選項解析有問題，建議檢查CSV格式`, 'error');
                }, 3000);
            }
        }

        // 生成調試內容
        function generateDebugContent(problemQuestions, incompleteQuestions, goodQuestions) {
            const debugContainer = document.getElementById('debug-content');
            
            const debugHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="result-card">
                        <div class="result-number" style="color: var(--success-green);">${goodQuestions.length}</div>
                        <h4>完整題目 (≥4選項)</h4>
                    </div>
                    <div class="result-card">
                        <div class="result-number" style="color: var(--warning-orange);">${incompleteQuestions.length}</div>
                        <h4>不完整題目 (<4選項)</h4>
                    </div>
                    <div class="result-card">
                        <div class="result-number" style="color: var(--error-red);">${problemQuestions.length}</div>
                        <h4>問題題目 (<2選項)</h4>
                    </div>
                </div>
                
                ${problemQuestions.length > 0 ? `
                    <div style="background: var(--light-red); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: var(--error-red); margin-bottom: 1rem;">⚠️ 問題題目列表 (選項<2個)</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${problemQuestions.map(q => 
                                `<span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                                    題目${q.id} (${q.options.length}個選項)
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${incompleteQuestions.length > 0 ? `
                    <div style="background: var(--light-orange); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: var(--warning-orange); margin-bottom: 1rem;">⚠️ 不完整題目列表 (選項<4個)</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${incompleteQuestions.slice(0, 20).map(q => 
                                `<span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                                    題目${q.id} (${q.options.length}個選項)
                                </span>`
                            ).join('')}
                            ${incompleteQuestions.length > 20 ? 
                                `<span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                                    ...還有${incompleteQuestions.length - 20}道
                                </span>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; font-size: 0.9rem;">
                    <h4 style="margin-bottom: 1rem;">💡 解決建議</h4>
                    <ul style="line-height: 1.6; margin-left: 1rem;">
                        <li>如果問題題目很多，請檢查原始CSV文件格式是否正確</li>
                        <li>確認題目和選項之間是否有空行或其他內容干擾</li>
                        <li>選項格式應為：(A) 選項內容、(B) 選項內容等</li>
                        <li>可以嘗試重新上傳CSV文件或聯繫技術支援</li>
                    </ul>
                </div>
            `;
            
            debugContainer.innerHTML = debugHtml;
        }

        // 載入題目數據
        async function loadQuestions() {
            try {
                // 首先嘗試從同目錄讀取CSV文件（部署時使用）
                console.log('嘗試載入CSV文件...');
                const response = await fetch('./ERP_Questions.csv');
                
                if (response.ok) {
                    const csvContent = await response.text();
                    console.log('成功讀取CSV文件');
                    parseCSVContent(csvContent);
                    
                    if (questions.length > 0) {
                        console.log(`從CSV成功載入 ${questions.length} 道題目`);
                        return;
                    }
                }
                
                // 如果fetch失敗，嘗試使用文件系統API
                if (window.fs && window.fs.readFile) {
                    console.log('嘗試使用文件系統API...');
                    const csvContent = await window.fs.readFile('ERP_Questions.csv', { encoding: 'utf8' });
                    parseCSVContent(csvContent);
                    if (questions.length > 0) {
                        console.log(`從文件系統成功載入 ${questions.length} 道題目`);
                        return;
                    }
                }
                
            } catch (error) {
                console.log('自動載入失敗，將使用演示模式:', error.message);
            }
            
            // 如果所有自動載入方式都失敗，載入演示題目
            loadSampleQuestions();
        }

        // 解析CSV內容
        function parseCSVContent(csvContent) {
            console.log('開始解析CSV內容...');
            const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line && line !== 'Content');
            console.log(`CSV總行數: ${lines.length}`);
            
            let currentChapter = "";
            const questionLines = [];
            
            // 找到所有題目行
            lines.forEach((line, index) => {
                const match = line.match(/^\(([A-D])\)\s*(\d+)\.\s*(.+)/);
                if (match) {
                    const answer = match[1];
                    const questionId = parseInt(match[2]);
                    const questionText = match[3];
                    
                    if (questionId >= 1 && questionId <= 500) {
                        questionLines.push({
                            lineIndex: index,
                            questionId: questionId,
                            answer: answer,
                            questionText: questionText,
                            fullLine: line
                        });
                    }
                }
            });
            
            console.log(`找到 ${questionLines.length} 道題目行`);
            
            // 按題目ID排序
            questionLines.sort((a, b) => a.questionId - b.questionId);
            
            // 為每道題目收集選項和章節信息
            let processedCount = 0;
            for (let i = 0; i < questionLines.length; i++) {
                const currentQ = questionLines[i];
                const nextQ = questionLines[i + 1];
                
                let questionText = currentQ.questionText;
                let options = [];
                
                // 在當前題目之前查找章節信息
                for (let k = currentQ.lineIndex - 1; k >= 0; k--) {
                    const prevLine = lines[k];
                    if (prevLine.includes("第") && prevLine.includes("章")) {
                        currentChapter = prevLine.replace(/\d+中華企業資源規劃學會 專業認證/, '').trim();
                        break;
                    }
                    if (k === 0 || lines[k].match(/^\([A-D]\)\s*\d+\./)) {
                        break;
                    }
                }
                
                // 收集選項 - 全新的邏輯
                const startIndex = currentQ.lineIndex + 1;
                const endIndex = nextQ ? nextQ.lineIndex : lines.length;
                
                console.log(`\n處理題目 ${currentQ.questionId} (行 ${currentQ.lineIndex + 1})`);
                
                for (let j = startIndex; j < endIndex; j++) {
                    let line = lines[j];
                    
                    // 跳過標題行和章節行
                    if (line.includes("ERP 規劃師") || 
                        line.includes("試 題 指 南") || 
                        line.includes("ERP規劃師-參考題型") ||
                        line.includes("中華企業資源規劃學會") ||
                        (line.includes("第") && line.includes("章"))) {
                        continue;
                    }
                    
                    // 清理雙引號
                    if (line.startsWith('"') && line.endsWith('"')) {
                        line = line.slice(1, -1);
                    }
                    
                    // 檢查是否為選項行
                    const isOptionLine = line.match(/^\([A-D]\)/);
                    const isQuestionLine = line.match(/^\([A-D]\)\s*\d+\./);
                    
                    if (isOptionLine && !isQuestionLine) {
                        // 這是選項行，不是題目行
                        options.push(line);
                        console.log(`  找到選項: ${line}`);
                    } else if (isQuestionLine) {
                        // 遇到下一題目，停止收集
                        console.log(`  遇到下一題目，停止收集`);
                        break;
                    } else if (options.length === 0 && line.trim()) {
                        // 如果還沒開始收集選項，這可能是題目內容的延續
                        questionText += " " + line;
                        console.log(`  題目內容延續: ${line}`);
                    }
                    
                    // 安全限制：如果已經收集了足夠的選項，停止
                    if (options.length >= 8) {
                        break;
                    }
                }
                
                console.log(`題目 ${currentQ.questionId} 收集到 ${options.length} 個選項`);
                
                // 創建題目對象 - 即使選項為0也要保存
                questions.push({
                    id: currentQ.questionId,
                    question: questionText.trim(),
                    answer: currentQ.answer,
                    options: options,
                    chapter: currentChapter || "第 1 章 企業資源規劃簡介"
                });
                
                processedCount++;
                
                // 調試信息
                if (options.length === 0) {
                    console.log(`⚠️ 題目 ${currentQ.questionId} 沒有找到選項`);
                } else if (options.length < 4) {
                    console.log(`⚠️ 題目 ${currentQ.questionId} 選項不足 (${options.length} 個)`);
                }
            }
            
            // 按題目編號排序
            questions.sort((a, b) => a.id - b.id);
            console.log(`CSV解析完成，成功處理 ${processedCount} 道題目`);
            
            // 統計選項數量分布
            const optionStats = {};
            questions.forEach(q => {
                const count = q.options.length;
                optionStats[count] = (optionStats[count] || 0) + 1;
            });
            console.log('選項數量統計:', optionStats);
        }

        // 生成題庫瀏覽內容
        function generateBrowseContent(filteredQuestions = null) {
            const container = document.getElementById('browse-container');
            const questionsToShow = filteredQuestions || questions;
            
            if (questionsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-600);">沒有找到符合條件的題目</p>';
                return;
            }
            
            container.innerHTML = questionsToShow.map(q => {
                let optionsHtml = '';
                
                if (q.options && q.options.length > 0) {
                    optionsHtml = q.options.map(option => {
                        // 更安全的選項解析
                        const letterMatch = option.match(/^\(([A-D])\)/);
                        if (letterMatch) {
                            const optionLetter = letterMatch[1];
                            const optionText = option.replace(/^\([A-D]\)\s*/, '');
                            const isCorrect = optionLetter === q.answer;
                            
                            return `
                                <div class="browse-option ${isCorrect ? 'correct-answer' : ''}">
                                    <strong>${optionLetter})</strong> ${optionText}
                                    ${isCorrect ? ' ✓' : ''}
                                </div>
                            `;
                        } else {
                            // 如果選項格式不正確，仍然顯示
                            return `
                                <div class="browse-option">
                                    <strong>?)</strong> ${option}
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    optionsHtml = `
                        <div style="color: var(--error-red); font-style: italic; padding: 1rem;">
                            ⚠️ 此題目選項解析失敗，可能原始格式有問題
                        </div>
                    `;
                }
                
                return `
                    <div class="browse-item">
                        <div class="browse-question-header">
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <div class="browse-question-number">題目 ${q.id}</div>
                                <div class="browse-chapter">${q.chapter}</div>
                            </div>
                            <div class="browse-answer">答案: ${q.answer}</div>
                        </div>
                        
                        <div class="browse-question-text">${q.question}</div>
                        
                        <div class="browse-options">
                            ${optionsHtml}
                        </div>
                        
                        ${q.options.length === 0 ? 
                            `<div style="margin-top: 1rem; padding: 1rem; background: var(--light-red); border-radius: 6px; font-size: 0.9rem;">
                                <strong>調試信息：</strong>此題目在CSV解析時未找到有效選項，請檢查原始檔案中題目 ${q.id} 的格式。
                            </div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }

        // 生成章節篩選選項
        function generateChapterFilter() {
            const select = document.getElementById('chapter-filter');
            const chapters = [...new Set(questions.map(q => q.chapter))].sort();
            
            select.innerHTML = '<option value="">所有章節</option>' + 
                chapters.map(chapter => `<option value="${chapter}">${chapter}</option>`).join('');
        }

        // 按章節篩選
        function filterByChapter() {
            const selectedChapter = document.getElementById('chapter-filter').value;
            const filterBadge = document.getElementById('browse-filter');
            
            if (selectedChapter) {
                const filteredQuestions = questions.filter(q => q.chapter === selectedChapter);
                generateBrowseContent(filteredQuestions);
                filterBadge.textContent = selectedChapter;
            } else {
                generateBrowseContent();
                filterBadge.textContent = '所有章節';
            }
        }
        function uploadCSVFile() {
            const fileInput = document.getElementById('csv-file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('請先選擇CSV文件！');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('請選擇CSV格式的文件！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvContent = e.target.result;
                
                // 清空現有題目
                questions = [];
                userAnswers = {};
                
                // 解析新的CSV內容
                parseCSVContent(csvContent);
                
                if (questions.length > 0) {
                    // 重新初始化界面
                    generateOverview();
                    updateStats();
                    showQuestion(0);
                    
                    // 隱藏上傳區域
                    document.getElementById('upload-section').style.display = 'none';
                    
                    showNotification(`成功載入 ${questions.length} 道題目！🎉`, 'success');
                } else {
                    showNotification('CSV文件格式不正確，請檢查文件內容！❌', 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('文件讀取失敗，請重試！❌', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // 載入示例題目（當無法讀取CSV時使用）
        function loadSampleQuestions() {
            questions = [
                {
                    id: 1,
                    question: "ERP 系統最新的主流趨勢是採用下列哪一種基本技術架構",
                    answer: "D",
                    options: [
                        "(A) 集中式架構",
                        "(B) 分散式架構", 
                        "(C) 同儕計算架構",
                        "(D) 多層式(Multi-tier)主從架構"
                    ],
                    chapter: "第 1 章 企業資源規劃簡介"
                },
                {
                    id: 2,
                    question: "ERP 系統能即時整合各流程資料的原因為",
                    answer: "A",
                    options: [
                        "(A) 各流程資料儲存於同一資料庫中",
                        "(B) 快速的電腦運算",
                        "(C) 電子商務的盛行", 
                        "(D) 政府鼓勵"
                    ],
                    chapter: "第 1 章 企業資源規劃簡介"
                },
                {
                    id: 11,
                    question: "在銷售與配銷模組中，下列何者為企業從事行銷作業(Marketing Activity)時，最常用而且為最有效的方式",
                    answer: "A",
                    options: [
                        "(A) 直效郵遞 (Direct Mailing, DM)",
                        "(B) 研討會",
                        "(C) 銷售電話",
                        "(D) 銷售講座"
                    ],
                    chapter: "第 3 章 銷售與配銷模組"
                },
                {
                    id: 78,
                    question: "以下何者不是生產規劃的目的",
                    answer: "A",
                    options: [
                        "(A) 增加產品種類",
                        "(B) 降低生產成本",
                        "(C) 提高生產效率",
                        "(D) 確保交期準確"
                    ],
                    chapter: "第 4 章 生產規劃與控制"
                },
                {
                    id: 133,
                    question: "下列何者不是影響企業採購發展趨勢的因素",
                    answer: "A",
                    options: [
                        "(A) 企業組織規模擴大",
                        "(B) 全球競爭加劇",
                        "(C) 資訊科技發達",
                        "(D) 供應商策略聯盟"
                    ],
                    chapter: "第 5 章 企業之採購管理"
                },
                {
                    id: 186,
                    question: "在庫存管理系統中，ABC 分析法是利用何種法則發展出來的存貨分類方法",
                    answer: "C",
                    options: [
                        "(A) 經濟訂購批量法則",
                        "(B) 安全存量法則",
                        "(C) 柏拉圖 80-20 法則",
                        "(D) 再訂購點法則"
                    ],
                    chapter: "第 6 章 庫存管理系統"
                },
                {
                    id: 269,
                    question: "財務會計作業的主要目的為",
                    answer: "B",
                    options: [
                        "(A) 內部管理決策",
                        "(B) 對外財務報告",
                        "(C) 成本控制分析",
                        "(D) 預算編制規劃"
                    ],
                    chapter: "第 7 章 ERP 財務會計模組"
                },
                {
                    id: 310,
                    question: "在成本控制模組中，下列何者屬於變動成本",
                    answer: "A",
                    options: [
                        "(A) 直接材料成本",
                        "(B) 廠房折舊費用",
                        "(C) 管理人員薪資",
                        "(D) 設備租賃費用"
                    ],
                    chapter: "第 8 章 成本控制模組"
                },
                {
                    id: 360,
                    question: "人力資源管理模組的主要功能不包括",
                    answer: "D",
                    options: [
                        "(A) 招募與甄選",
                        "(B) 訓練與發展",
                        "(C) 薪資管理",
                        "(D) 產品設計"
                    ],
                    chapter: "第 9 章 人力資源模組"
                },
                {
                    id: 394,
                    question: "ERP 系統導入過程中，最重要的成功因素為",
                    answer: "B",
                    options: [
                        "(A) 技術先進性",
                        "(B) 高階主管支持",
                        "(C) 系統功能完整",
                        "(D) 成本控制嚴格"
                    ],
                    chapter: "第 11 章 系統導入"
                },
                {
                    id: 408,
                    question: "雲端運算具有下列哪些基本特性",
                    answer: "A",
                    options: [
                        "(A) 隨選即用的自助服務",
                        "(B) 固定的資源配置",
                        "(C) 單一存取方式",
                        "(D) 人工資源管理"
                    ],
                    chapter: "第 14 章 企業雲端運算與應用"
                },
                {
                    id: 433,
                    question: "ERP 系統必須建置在一套穩定的資料庫系統之上，下列何者不是資料庫軟體",
                    answer: "B",
                    options: [
                        "(A) Oracle",
                        "(B) Windows",
                        "(C) SQL Server",
                        "(D) MySQL"
                    ],
                    chapter: "第 16 章 資料庫管理與 ERP 系統"
                }
            ];
            console.log(`載入了 ${questions.length} 道示例題目（演示模式 - 涵蓋各主要章節）`);
        }

        // 生成題庫總覽網格
        function generateOverview() {
            const grid = document.getElementById('overview-grid');
            grid.innerHTML = '';
            
            // 更新輸入框最大值
            const questionInput = document.getElementById('question-input');
            if (questions.length > 0) {
                const maxId = Math.max(...questions.map(q => q.id));
                questionInput.max = maxId;
            }
            
            questions.forEach(q => {
                const numberEl = document.createElement('div');
                numberEl.className = 'question-number unanswered';
                numberEl.textContent = q.id;
                numberEl.onclick = () => {
                    currentQuestionIndex = questions.findIndex(question => question.id === q.id);
                    showPanel('practice');
                    showQuestion(currentQuestionIndex);
                };
                
                // 根據答題狀態設置樣式
                if (userAnswers[q.id]) {
                    if (userAnswers[q.id] === q.answer) {
                        numberEl.className = 'question-number correct';
                    } else {
                        numberEl.className = 'question-number incorrect';
                    }
                }
                
                grid.appendChild(numberEl);
            });
        }

        // 顯示指定題目
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            currentQuestionIndex = index;
            const question = questions[index];
            showingAnswer = false;
            
            // 更新題目信息
            document.getElementById('current-question-badge').textContent = `題目 ${question.id}`;
            document.getElementById('current-chapter-badge').textContent = question.chapter;
            document.getElementById('question-text').textContent = question.question;
            document.getElementById('question-input').value = question.id;
            
            // 生成選項
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach((option, i) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'option';
                    
                    // 更安全的選項解析
                    const letterMatch = option.match(/^\(([A-D])\)/);
                    if (letterMatch) {
                        const letter = letterMatch[1];
                        const text = option.replace(/^\([A-D]\)\s*/, '');
                        
                        optionEl.innerHTML = `
                            <div class="option-letter">${letter}</div>
                            <div>${text}</div>
                        `;
                        
                        optionEl.onclick = () => selectOption(letter, optionEl);
                    } else {
                        // 如果格式不正確，仍然顯示
                        optionEl.innerHTML = `
                            <div class="option-letter">?</div>
                            <div>${option}</div>
                        `;
                    }
                    
                    optionsContainer.appendChild(optionEl);
                });
            } else {
                // 如果沒有選項，顯示提示
                optionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--error-red);">
                        ⚠️ 此題目選項解析失敗，請檢查原始數據格式<br>
                        <small>題目 ${question.id} 的選項可能格式不正確</small>
                    </div>
                `;
            }
            
            // 如果已經答過，顯示之前的選擇
            if (userAnswers[question.id]) {
                const selectedOption = optionsContainer.querySelector(`[onclick*="${userAnswers[question.id]}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
            
            // 更新按鈕狀態
            updateButtonStates();
            
            // 標記當前題目
            updateOverviewHighlight();
        }

        // 選擇選項
        function selectOption(letter, element) {
            if (showingAnswer) return;
            
            // 清除所有選中狀態
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 設置當前選中
            element.classList.add('selected');
            
            // 顯示確認按鈕
            document.getElementById('submit-btn').style.display = 'inline-block';
            document.getElementById('next-btn').style.display = 'none';
        }

        // 提交答案
        function submitAnswer() {
            const question = questions[currentQuestionIndex];
            const selectedOption = document.querySelector('.option.selected');
            
            if (!selectedOption) return;
            
            const userAnswer = selectedOption.querySelector('.option-letter').textContent;
            userAnswers[question.id] = userAnswer;
            
            // 顯示正確答案
            showingAnswer = true;
            const options = document.querySelectorAll('.option');
            
            options.forEach(opt => {
                const letter = opt.querySelector('.option-letter').textContent;
                if (letter === question.answer) {
                    opt.classList.add('correct');
                } else if (letter === userAnswer && letter !== question.answer) {
                    opt.classList.add('incorrect');
                }
            });
            
            // 更新按鈕
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            
            // 保存答題記錄
            saveAnswers();
            
            // 更新統計
            updateStats();
            generateOverview();
            updateResults();
            
            // 給出視覺反饋
            if (userAnswer === question.answer) {
                showNotification('正確！✅', 'success');
            } else {
                showNotification('錯誤！❌', 'error');
            }
        }

        // 錯題練習相關函數
        function getWrongQuestions() {
            return questions.filter(q => {
                const userAnswer = userAnswers[q.id];
                return userAnswer && userAnswer !== q.answer;
            });
        }

        function updateWrongQuestionsDisplay() {
            wrongQuestions = getWrongQuestions();
            const countText = document.getElementById('wrong-count-text');
            const badge = document.getElementById('wrong-progress-badge');
            
            if (wrongQuestions.length === 0) {
                countText.textContent = '請先完成一些題目來建立錯題庫';
                badge.textContent = '暫無錯題';
            } else {
                countText.textContent = `發現 ${wrongQuestions.length} 道錯題，建議重新練習`;
                badge.textContent = `${wrongQuestions.length} 道錯題`;
            }
        }

        function startWrongPractice() {
            wrongQuestions = getWrongQuestions();
            
            if (wrongQuestions.length === 0) {
                showNotification('暫無錯題，請先完成一些題目！', 'error');
                return;
            }
            
            document.getElementById('wrong-welcome').style.display = 'none';
            document.getElementById('wrong-practice-content').style.display = 'block';
            
            currentWrongIndex = loadFromStorage(STORAGE_KEYS.LAST_WRONG_QUESTION, 0);
            if (currentWrongIndex >= wrongQuestions.length) {
                currentWrongIndex = 0;
            }
            
            showWrongQuestion(currentWrongIndex);
            updateWrongProgress();
        }

        function showWrongQuestion(index) {
            if (index < 0 || index >= wrongQuestions.length) return;
            
            currentWrongIndex = index;
            const question = wrongQuestions[index];
            showingWrongAnswer = false;
            
            // 更新題目信息
            document.getElementById('wrong-current-badge').textContent = `錯題 ${index + 1}`;
            document.getElementById('wrong-chapter-badge').textContent = question.chapter;
            document.getElementById('wrong-question-text').textContent = question.question;
            
            // 生成選項
            const optionsContainer = document.getElementById('wrong-options-container');
            optionsContainer.innerHTML = '';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach((option, i) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'option';
                    
                    const letterMatch = option.match(/^\(([A-D])\)/);
                    if (letterMatch) {
                        const letter = letterMatch[1];
                        const text = option.replace(/^\([A-D]\)\s*/, '');
                        
                        optionEl.innerHTML = `
                            <div class="option-letter">${letter}</div>
                            <div>${text}</div>
                        `;
                        
                        optionEl.onclick = () => selectWrongOption(letter, optionEl);
                        
                        // 顯示之前的錯誤答案
                        const userAnswer = userAnswers[question.id];
                        if (letter === userAnswer) {
                            optionEl.classList.add('incorrect');
                            optionEl.innerHTML += '<small style="color: var(--error-red); display: block; margin-top: 0.5rem;">上次選擇（錯誤）</small>';
                        }
                        if (letter === question.answer) {
                            optionEl.classList.add('correct');
                            optionEl.innerHTML += '<small style="color: var(--success-green); display: block; margin-top: 0.5rem;">正確答案</small>';
                        }
                    }
                    
                    optionsContainer.appendChild(optionEl);
                });
            }
            
            // 檢查是否已經重新作答
            if (wrongAnswers[question.id]) {
                const selectedOption = optionsContainer.querySelector(`[onclick*="${wrongAnswers[question.id]}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
            
            updateWrongButtonStates();
            updateWrongProgress();
            saveWrongAnswers();
        }

        function selectWrongOption(letter, element) {
            if (showingWrongAnswer) return;
            
            // 清除所有選中狀態
            document.querySelectorAll('#wrong-options-container .option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 設置當前選中
            element.classList.add('selected');
            
            // 顯示確認按鈕
            document.getElementById('wrong-submit-btn').style.display = 'inline-block';
            document.getElementById('wrong-next-btn').style.display = 'none';
        }

        function submitWrongAnswer() {
            const question = wrongQuestions[currentWrongIndex];
            const selectedOption = document.querySelector('#wrong-options-container .option.selected');
            
            if (!selectedOption) return;
            
            const userAnswer = selectedOption.querySelector('.option-letter').textContent;
            wrongAnswers[question.id] = userAnswer;
            
            // 更新按鈕
            document.getElementById('wrong-submit-btn').style.display = 'none';
            document.getElementById('wrong-next-btn').style.display = 'inline-block';
            
            // 保存錯題練習記錄
            saveWrongAnswers();
            
            // 給出反饋
            if (userAnswer === question.answer) {
                showNotification('這次答對了！✅', 'success');
                // 從用戶錯題記錄中移除（表示已經掌握）
                // 這裡可以選擇是否要更新主要的userAnswers
            } else {
                showNotification('還是錯誤，再想想！❌', 'error');
            }
        }

        function previousWrongQuestion() {
            if (currentWrongIndex > 0) {
                showWrongQuestion(currentWrongIndex - 1);
            }
        }

        function nextWrongQuestion() {
            if (currentWrongIndex < wrongQuestions.length - 1) {
                showWrongQuestion(currentWrongIndex + 1);
            }
        }

        function updateWrongButtonStates() {
            const prevBtn = document.getElementById('wrong-prev-btn');
            const nextBtn = document.getElementById('wrong-next-btn');
            
            prevBtn.disabled = currentWrongIndex === 0;
            nextBtn.disabled = currentWrongIndex === wrongQuestions.length - 1;
            
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
        }

        function updateWrongProgress() {
            const progressText = document.getElementById('wrong-progress-text');
            if (wrongQuestions.length > 0) {
                progressText.textContent = `${currentWrongIndex + 1} / ${wrongQuestions.length}`;
            } else {
                progressText.textContent = '0 / 0';
            }
        }

        function resetWrongQuestions() {
            if (confirm('確定要重置錯題記錄嗎？這將清除錯題練習的進度。')) {
                wrongAnswers = {};
                currentWrongIndex = 0;
                saveWrongAnswers();
                
                document.getElementById('wrong-welcome').style.display = 'block';
                document.getElementById('wrong-practice-content').style.display = 'none';
                
                updateWrongQuestionsDisplay();
                showNotification('錯題記錄已重置！', 'success');
            }
        }

        // 顯示通知
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 1rem 2rem;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: var(--success-green);' : 'background: var(--error-red);'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // 上一題
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
                saveAnswers(); // 保存當前位置
            }
        }

        // 下一題
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
                saveAnswers(); // 保存當前位置
            }
        }

        // 跳至指定題目
        function goToQuestion() {
            const questionId = parseInt(document.getElementById('question-input').value);
            const index = questions.findIndex(q => q.id === questionId);
            
            if (index !== -1) {
                showQuestion(index);
                saveAnswers(); // 保存當前位置
            } else {
                alert('題目編號不存在！');
            }
        }

        // 更新按鈕狀態
        function updateButtonStates() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === questions.length - 1;
            
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
        }

        // 更新總覽高亮
        function updateOverviewHighlight() {
            document.querySelectorAll('.question-number').forEach(el => {
                el.classList.remove('current');
            });
            
            const currentEl = document.querySelector(`[onclick*="${questions[currentQuestionIndex].id}"]`);
            if (currentEl) {
                currentEl.classList.add('current');
            }
        }

        // 更新統計信息
        function updateStats() {
            const answered = Object.keys(userAnswers).length;
            const correct = Object.entries(userAnswers).filter(([id, answer]) => {
                const question = questions.find(q => q.id == id);
                return question && question.answer === answer;
            }).length;
            const incorrect = answered - correct;
            
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('incorrectCount').textContent = incorrect;
            document.getElementById('totalAnswered').textContent = answered;
            
            // 更新進度條
            const totalQuestions = questions.length;
            const progressPercent = totalQuestions > 0 ? (answered / totalQuestions) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            document.getElementById('progress-text').textContent = `${answered} / ${totalQuestions} (${Math.round(progressPercent)}%)`;
        }

        // 更新結果面板
        function updateResults() {
            const answered = Object.keys(userAnswers).length;
            const correct = Object.entries(userAnswers).filter(([id, answer]) => {
                const question = questions.find(q => q.id == id);
                return question && question.answer === answer;
            }).length;
            const incorrect = answered - correct;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            
            document.getElementById('result-correct').textContent = correct;
            document.getElementById('result-incorrect').textContent = incorrect;
            document.getElementById('result-total').textContent = answered;
            document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
            
            // 更新錯題列表 - 顯示完整信息
            const incorrectContainer = document.getElementById('incorrect-questions');
            const incorrectQuestions = Object.entries(userAnswers).filter(([id, answer]) => {
                const question = questions.find(q => q.id == id);
                return question && question.answer !== answer;
            });
            
            if (incorrectQuestions.length === 0) {
                incorrectContainer.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 2rem;">還沒有錯題記錄，繼續加油！ 💪</p>';
            } else {
                incorrectContainer.innerHTML = incorrectQuestions.map(([id, userAnswer]) => {
                    const question = questions.find(q => q.id == id);
                    if (!question) return '';
                    
                    // 生成完整選項HTML
                    const optionsHtml = question.options.map(option => {
                        const letterMatch = option.match(/^\(([A-D])\)/);
                        if (!letterMatch) return `<div style="padding: 0.25rem 0;">${option}</div>`;
                        
                        const letter = letterMatch[1];
                        const text = option.replace(/^\([A-D]\)\s*/, '');
                        
                        let className = 'padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px;';
                        let suffix = '';
                        
                        if (letter === question.answer) {
                            className += ' background: var(--light-green); border-left: 3px solid var(--success-green); color: var(--success-green);';
                            suffix = ' ✓ 正確答案';
                        } else if (letter === userAnswer) {
                            className += ' background: var(--light-red); border-left: 3px solid var(--error-red); color: var(--error-red);';
                            suffix = ' ✗ 你的答案';
                        } else {
                            className += ' background: var(--gray-50);';
                        }
                        
                        return `<div style="${className}"><strong>${letter})</strong> ${text}${suffix}</div>`;
                    }).join('');
                    
                    return `
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span style="background: var(--error-red); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
                                        題目 ${id}
                                    </span>
                                    <span style="background: var(--light-blue); color: var(--primary-blue); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                        ${question.chapter}
                                    </span>
                                </div>
                                <button class="btn btn-secondary" onclick="practiceThisQuestion(${id})" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                    重新練習
                                </button>
                            </div>
                            
                            <div style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem; color: var(--gray-800);">
                                <strong>題目：</strong>${question.question}
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>選項：</strong>
                                <div style="margin-top: 0.5rem;">
                                    ${optionsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // 更新錯題練習顯示
            updateWrongQuestionsDisplay();
        }

        // 練習特定題目
        function practiceThisQuestion(questionId) {
            const questionIndex = questions.findIndex(q => q.id == questionId);
            if (questionIndex !== -1) {
                currentQuestionIndex = questionIndex;
                showPanel('practice');
                showQuestion(currentQuestionIndex);
                showNotification(`跳轉到題目 ${questionId}`, 'success');
            }
        }

        // 面板切換
        function showPanel(panelName) {
            // 隱藏所有面板
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 移除所有標籤的激活狀態
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 顯示指定面板
            document.getElementById(`${panelName}-panel`).classList.add('active');
            
            // 激活對應標籤
            event.target.classList.add('active');
            
            // 特殊處理
            if (panelName === 'browse' && document.getElementById('browse-container').innerHTML === '') {
                generateBrowseContent();
                generateChapterFilter();
            } else if (panelName === 'wrong') {
                updateWrongQuestionsDisplay();
                // 如果有錯題且正在練習中，恢復練習狀態
                const wrongQs = getWrongQuestions();
                if (wrongQs.length > 0 && document.getElementById('wrong-practice-content').style.display === 'block') {
                    // 已經在練習中，不需要特殊處理
                } else if (wrongQs.length > 0 && loadFromStorage(STORAGE_KEYS.LAST_WRONG_QUESTION, -1) >= 0) {
                    // 有保存的錯題練習進度，詢問是否繼續
                    const continueBtn = document.createElement('button');
                    continueBtn.textContent = '繼續上次的錯題練習';
                    continueBtn.className = 'btn btn-success';
                    continueBtn.style.marginLeft = '1rem';
                    continueBtn.onclick = startWrongPractice;
                    
                    const welcomeDiv = document.getElementById('wrong-welcome');
                    if (welcomeDiv && !welcomeDiv.querySelector('.continue-btn')) {
                        continueBtn.classList.add('continue-btn');
                        welcomeDiv.appendChild(continueBtn);
                    }
                }
            }
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('practice-panel').classList.contains('active')) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousQuestion();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        nextQuestion();
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        if (!showingAnswer) {
                            const optionLetter = String.fromCharCode(64 + parseInt(e.key)); // 1->A, 2->B, etc.
                            const optionEl = document.querySelector(`[onclick*="${optionLetter}"]`);
                            if (optionEl) {
                                selectOption(optionLetter, optionEl);
                            }
                        }
                        break;
                    case 'Enter':
                        if (document.getElementById('submit-btn').style.display !== 'none') {
                            submitAnswer();
                        }
                        break;
                }
            }
        });

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>